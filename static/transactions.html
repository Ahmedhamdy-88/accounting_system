<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المعاملات - نظام المحاسبة للإنتاج الفني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar for desktop -->
        <div class="sidebar w-64 text-white hidden md:block">
            <div class="p-4">
                <div class="flex items-center justify-center mb-8">
                    <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-film text-white"></i>
                    </div>
                </div>
                <div class="mb-10 text-center">
                    <div class="h-16 w-16 mx-auto rounded-full border-2 border-white mb-2 bg-gray-600 flex items-center justify-center">
                        <i class="fas fa-user text-white text-xl"></i>
                    </div>
                    <h4 class="font-bold" id="currentUserName">المستخدم</h4>
                    <p class="text-xs text-gray-300" id="currentUserRole">الدور</p>
                </div>
                <nav>
                    <div class="mb-4">
                        <h5 class="text-sm uppercase text-gray-400 mb-2 px-4">القائمة الرئيسية</h5>
                        <a href="/dashboard.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-chart-line mr-2"></i> لوحة التحكم
                        </a>
                        <a href="/projects.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-film mr-2"></i> المشاريع
                        </a>
                        <a href="/payroll.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-money-bill-wave mr-2"></i> الرواتب والمصروفات
                        </a>
                        <a href="/transactions.html" class="block py-2 px-4 rounded-lg bg-gray-800 text-white mb-1">
                            <i class="fas fa-dollar-sign mr-2"></i> المعاملات
                        </a>
                        <a href="/reports.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-chart-pie mr-2"></i> التقارير
                        </a>
                    </div>
                    <div class="mb-4" id="adminSection" style="display: none;">
                        <h5 class="text-sm uppercase text-gray-400 mb-2 px-4">الإدارة</h5>
                        <a href="/users.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-users mr-2"></i> المستخدمين
                        </a>
                        <a href="/settings.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-cog mr-2"></i> الإعدادات
                        </a>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Mobile menu overlay -->
        <div id="mobileMenu" class="fixed inset-0 z-50 md:hidden hidden">
            <div class="fixed inset-0 bg-black bg-opacity-50" id="mobileMenuOverlay"></div>
            <div class="fixed right-0 top-0 h-full w-64 bg-gray-800 text-white transform transition-transform duration-300 ease-in-out">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-8">
                        <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-film text-white"></i>
                        </div>
                        <button id="closeMobileMenu" class="text-white hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="mb-10 text-center">
                        <div class="h-16 w-16 mx-auto rounded-full border-2 border-white mb-2 bg-gray-600 flex items-center justify-center">
                            <i class="fas fa-user text-white text-xl"></i>
                        </div>
                        <h4 class="font-bold" id="mobileCurrentUserName">المستخدم</h4>
                        <p class="text-xs text-gray-300" id="mobileCurrentUserRole">الدور</p>
                    </div>
                    <nav>
                        <div class="mb-4">
                            <h5 class="text-sm uppercase text-gray-400 mb-2 px-4">القائمة الرئيسية</h5>
                            <a href="/dashboard.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-chart-line mr-2"></i> لوحة التحكم
                            </a>
                            <a href="/projects.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-film mr-2"></i> المشاريع
                            </a>
                            <a href="/payroll.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-money-bill-wave mr-2"></i> الرواتب والمصروفات
                            </a>
                            <a href="/transactions.html" class="block py-2 px-4 rounded-lg bg-gray-700 text-white mb-1">
                                <i class="fas fa-dollar-sign mr-2"></i> المعاملات
                            </a>
                            <a href="/reports.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-chart-pie mr-2"></i> التقارير
                            </a>
                        </div>
                        <div class="mb-4" id="mobileAdminSection" style="display: none;">
                            <h5 class="text-sm uppercase text-gray-400 mb-2 px-4">الإدارة</h5>
                            <a href="/users.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-users mr-2"></i> المستخدمين
                            </a>
                            <a href="/settings.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-cog mr-2"></i> الإعدادات
                            </a>
                        </div>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <button id="mobileMenuButton" class="md:hidden mr-4 text-gray-600 hover:text-gray-900">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-900">إدارة المعاملات</h1>
                    </div>
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="relative">
                            <input type="text" placeholder="بحث..." class="bg-gray-100 border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-red-500" id="searchInput">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="relative">
                            <button class="text-gray-600 hover:text-gray-900 relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">3</span>
                            </button>
                        </div>
                        <div class="relative">
                            <button id="userMenuButton" class="flex items-center space-x-2 space-x-reverse text-gray-700 hover:text-gray-900">
                                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-sm"></i>
                                </div>
                                <span id="headerUserName">admin</span>
                                <i class="fas fa-chevron-down text-sm"></i>
                            </button>
                            <div id="userDropdown" class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">الملف الشخصي</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">الإعدادات</a>
                                <hr class="my-1">
                                <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">تسجيل الخروج</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page content -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Summary cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="dashboard-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">إجمالي الإيرادات</p>
                                    <p class="text-2xl font-bold text-green-600" id="totalRevenue">0 ج.م</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-arrow-up text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">إجمالي المصروفات</p>
                                    <p class="text-2xl font-bold text-red-600" id="totalExpenses">0 ج.م</p>
                                </div>
                                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-arrow-down text-red-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">الرصيد الحالي</p>
                                    <p class="text-2xl font-bold text-blue-600" id="currentBalance">0 ج.م</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-wallet text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add transaction form -->
                    <div class="dashboard-card p-6 mb-8">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">إضافة معاملة جديدة</h2>
                        <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">نوع المعاملة</label>
                                <select id="transactionType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">اختر نوع المعاملة</option>
                                    <option value="income">إيراد</option>
                                    <option value="expense">مصروف</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">المشروع</label>
                                <select id="projectSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">اختر المشروع</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الفئة</label>
                                <select id="categorySelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">اختر الفئة</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ (ج.م)</label>
                                <input type="number" id="amount" step="0.01" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0.00">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الوصف</label>
                                <input type="text" id="description" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="وصف المعاملة">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">التاريخ</label>
                                <input type="date" id="transactionDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                            </div>
                            
                            <div class="md:col-span-2 lg:col-span-3 flex gap-4">
                                <button type="submit" class="btn-cinematic px-6 py-2">
                                    <i class="fas fa-plus mr-2"></i>
                                    إضافة المعاملة
                                </button>
                                <button type="button" onclick="clearForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                                    <i class="fas fa-times mr-2"></i>
                                    إلغاء
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Transactions list -->
                    <div class="dashboard-card p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-4 md:mb-0">قائمة المعاملات</h2>
                            <div class="flex flex-col md:flex-row gap-4">
                                <select id="filterProject" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">جميع المشاريع</option>
                                </select>
                                <select id="filterType" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">جميع الأنواع</option>
                                    <option value="income">الإيرادات</option>
                                    <option value="expense">المصروفات</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">التاريخ</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">النوع</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">المشروع</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">الفئة</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">الوصف</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">المبلغ</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                            <i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i>
                                            <p>لا توجد معاملات حتى الآن</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="main.js"></script>
    <script>
        // Transaction management functionality
        let transactions = [];
        let projects = [];

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            loadTransactions();
            updateSummary();
            
            // Set today's date as default
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            
            // Setup form submission
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
            
            // Setup category change based on transaction type
            document.getElementById('transactionType').addEventListener('change', updateCategories);
            
            // Setup filters
            document.getElementById('filterProject').addEventListener('change', filterTransactions);
            document.getElementById('filterType').addEventListener('change', filterTransactions);
        });

        function loadProjects() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(data => {
                    projects = data;
                    updateProjectSelects();
                })
                .catch(error => console.error('Error loading projects:', error));
        }

        function updateProjectSelects() {
            const selects = ['projectSelect', 'filterProject'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                // Clear existing options except the first one
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            });
        }

        function updateCategories() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('categorySelect');
            
            // Clear existing options
            categorySelect.innerHTML = '<option value="">اختر الفئة</option>';
            
            let categories = [];
            if (type === 'income') {
                categories = ['مبيعات', 'استثمارات', 'رعاية', 'أخرى'];
            } else if (type === 'expense') {
                categories = ['رواتب', 'معدات', 'مواقع', 'تسويق', 'إنتاج', 'أخرى'];
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        function handleTransactionSubmit(e) {
            e.preventDefault();
            
            const formData = {
                type: document.getElementById('transactionType').value,
                project_id: document.getElementById('projectSelect').value,
                category: document.getElementById('categorySelect').value,
                amount: parseFloat(document.getElementById('amount').value),
                description: document.getElementById('description').value,
                date: document.getElementById('transactionDate').value
            };
            
            // Validate form
            if (!formData.type || !formData.amount || !formData.description || !formData.date) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // Add transaction (simulate API call)
            addTransaction(formData);
        }

        function addTransaction(transactionData) {
            // Simulate API call
            const transaction = {
                id: Date.now(),
                ...transactionData,
                created_at: new Date().toISOString()
            };
            
            transactions.push(transaction);
            updateTransactionsTable();
            updateSummary();
            clearForm();
            
            // Show success message
            alert('تم إضافة المعاملة بنجاح');
        }

        function loadTransactions() {
            // Simulate loading transactions
            updateTransactionsTable();
        }

        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsTableBody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i>
                            <p>لا توجد معاملات حتى الآن</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = transactions.map(transaction => {
                const project = projects.find(p => p.id == transaction.project_id);
                const typeClass = transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
                const typeIcon = transaction.type === 'income' ? 'fa-arrow-up' : 'fa-arrow-down';
                const typeText = transaction.type === 'income' ? 'إيراد' : 'مصروف';
                
                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${new Date(transaction.date).toLocaleDateString('ar-EG')}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="${typeClass}">
                                <i class="fas ${typeIcon} mr-1"></i>
                                ${typeText}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">${project ? project.name : 'غير محدد'}</td>
                        <td class="px-4 py-3 text-sm">${transaction.category || 'غير محدد'}</td>
                        <td class="px-4 py-3 text-sm">${transaction.description}</td>
                        <td class="px-4 py-3 text-sm font-medium ${typeClass}">${transaction.amount.toLocaleString()} ج.م</td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="editTransaction(${transaction.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransaction(${transaction.id})" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateSummary() {
            const totalRevenue = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const currentBalance = totalRevenue - totalExpenses;
            
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' ج.م';
            document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString() + ' ج.م';
            document.getElementById('currentBalance').textContent = currentBalance.toLocaleString() + ' ج.م';
        }

        function filterTransactions() {
            const projectFilter = document.getElementById('filterProject').value;
            const typeFilter = document.getElementById('filterType').value;
            
            // Apply filters (implement filtering logic here)
            updateTransactionsTable();
        }

        function clearForm() {
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        }

        function editTransaction(id) {
            // Implement edit functionality
            console.log('Edit transaction:', id);
        }

        function deleteTransaction(id) {
            if (confirm('هل أنت متأكد من حذف هذه المعاملة؟')) {
                transactions = transactions.filter(t => t.id !== id);
                updateTransactionsTable();
                updateSummary();
            }
        }
    </script>
</body>
</html>

