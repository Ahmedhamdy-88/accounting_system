<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير - نظام المحاسبة للإنتاج الفني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar for desktop -->
        <div class="sidebar w-64 text-white hidden md:block">
            <div class="p-4">
                <div class="flex items-center justify-center mb-8">
                    <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-film text-white"></i>
                    </div>
                </div>
                <div class="mb-10 text-center">
                    <div class="h-16 w-16 mx-auto rounded-full border-2 border-white mb-2 bg-gray-600 flex items-center justify-center">
                        <i class="fas fa-user text-white text-xl"></i>
                    </div>
                    <h4 class="font-bold" id="currentUserName">المستخدم</h4>
                    <p class="text-xs text-gray-300" id="currentUserRole">الدور</p>
                </div>
                <nav>
                    <div class="mb-4">
                        <h5 class="text-sm uppercase text-gray-400 mb-2 px-4">القائمة الرئيسية</h5>
                        <a href="/dashboard.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-chart-line mr-2"></i> لوحة التحكم
                        </a>
                        <a href="/projects.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-film mr-2"></i> المشاريع
                        </a>
                        <a href="/payroll.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-money-bill-wave mr-2"></i> الرواتب والمصروفات
                        </a>
                        <a href="/transactions.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-dollar-sign mr-2"></i> المعاملات
                        </a>
                        <a href="/reports.html" class="block py-2 px-4 rounded-lg bg-gray-800 text-white mb-1">
                            <i class="fas fa-chart-pie mr-2"></i> التقارير
                        </a>
                    </div>
                    <div class="mb-4" id="adminSection" style="display: none;">
                        <h5 class="text-sm uppercase text-gray-400 mb-2 px-4">الإدارة</h5>
                        <a href="/users.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-users mr-2"></i> المستخدمين
                        </a>
                        <a href="/settings.html" class="block py-2 px-4 rounded-lg hover:bg-gray-800 text-gray-300 mb-1">
                            <i class="fas fa-cog mr-2"></i> الإعدادات
                        </a>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Mobile menu overlay -->
        <div id="mobileMenu" class="fixed inset-0 z-50 md:hidden hidden">
            <div class="fixed inset-0 bg-black bg-opacity-50" id="mobileMenuOverlay"></div>
            <div class="fixed right-0 top-0 h-full w-64 bg-gray-800 text-white transform transition-transform duration-300 ease-in-out">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-8">
                        <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-film text-white"></i>
                        </div>
                        <button id="closeMobileMenu" class="text-white hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="mb-10 text-center">
                        <div class="h-16 w-16 mx-auto rounded-full border-2 border-white mb-2 bg-gray-600 flex items-center justify-center">
                            <i class="fas fa-user text-white text-xl"></i>
                        </div>
                        <h4 class="font-bold" id="mobileCurrentUserName">المستخدم</h4>
                        <p class="text-xs text-gray-300" id="mobileCurrentUserRole">الدور</p>
                    </div>
                    <nav>
                        <div class="mb-4">
                            <h5 class="text-sm uppercase text-gray-400 mb-2 px-4">القائمة الرئيسية</h5>
                            <a href="/dashboard.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-chart-line mr-2"></i> لوحة التحكم
                            </a>
                            <a href="/projects.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-film mr-2"></i> المشاريع
                            </a>
                            <a href="/payroll.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-money-bill-wave mr-2"></i> الرواتب والمصروفات
                            </a>
                            <a href="/transactions.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-dollar-sign mr-2"></i> المعاملات
                            </a>
                            <a href="/reports.html" class="block py-2 px-4 rounded-lg bg-gray-700 text-white mb-1">
                                <i class="fas fa-chart-pie mr-2"></i> التقارير
                            </a>
                        </div>
                        <div class="mb-4" id="mobileAdminSection" style="display: none;">
                            <h5 class="text-sm uppercase text-gray-400 mb-2 px-4">الإدارة</h5>
                            <a href="/users.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-users mr-2"></i> المستخدمين
                            </a>
                            <a href="/settings.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700 text-gray-300 mb-1">
                                <i class="fas fa-cog mr-2"></i> الإعدادات
                            </a>
                        </div>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <button id="mobileMenuButton" class="md:hidden mr-4 text-gray-600 hover:text-gray-900">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-900">التقارير والتحليلات</h1>
                    </div>
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="relative">
                            <input type="text" placeholder="بحث..." class="bg-gray-100 border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-red-500" id="searchInput">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="relative">
                            <button class="text-gray-600 hover:text-gray-900 relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">3</span>
                            </button>
                        </div>
                        <div class="relative">
                            <button id="userMenuButton" class="flex items-center space-x-2 space-x-reverse text-gray-700 hover:text-gray-900">
                                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-sm"></i>
                                </div>
                                <span id="headerUserName">admin</span>
                                <i class="fas fa-chevron-down text-sm"></i>
                            </button>
                            <div id="userDropdown" class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">الملف الشخصي</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">الإعدادات</a>
                                <hr class="my-1">
                                <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">تسجيل الخروج</a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page content -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Report filters -->
                    <div class="dashboard-card p-6 mb-8">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">فلاتر التقارير</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">المشروع</label>
                                <select id="reportProject" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="">جميع المشاريع</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">من تاريخ</label>
                                <input type="date" id="startDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">إلى تاريخ</label>
                                <input type="date" id="endDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                            </div>
                            <div class="flex items-end">
                                <button onclick="generateReport()" class="btn-cinematic w-full px-4 py-2">
                                    <i class="fas fa-chart-bar mr-2"></i>
                                    إنشاء التقرير
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Summary cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="dashboard-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">إجمالي الإيرادات</p>
                                    <p class="text-2xl font-bold text-green-600" id="reportTotalRevenue">0 ج.م</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-arrow-up text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">إجمالي المصروفات</p>
                                    <p class="text-2xl font-bold text-red-600" id="reportTotalExpenses">0 ج.م</p>
                                </div>
                                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-arrow-down text-red-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">صافي الربح</p>
                                    <p class="text-2xl font-bold text-blue-600" id="reportNetProfit">0 ج.م</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">عدد المشاريع</p>
                                    <p class="text-2xl font-bold text-purple-600" id="reportProjectCount">0</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-film text-purple-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="dashboard-card p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">الإيرادات والمصروفات الشهرية</h3>
                            <canvas id="monthlyChart" width="400" height="200"></canvas>
                        </div>
                        
                        <div class="dashboard-card p-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">توزيع المصروفات حسب الفئة</h3>
                            <canvas id="expenseChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Project performance -->
                    <div class="dashboard-card p-6 mb-8">
                        <h3 class="text-lg font-bold text-gray-900 mb-6">أداء المشاريع</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">اسم المشروع</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">النوع</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">الميزانية</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">المصروف</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">المتبقي</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">نسبة الإنجاز</th>
                                        <th class="px-4 py-3 text-right text-sm font-medium text-gray-700">الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="projectPerformanceTable">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                            <i class="fas fa-chart-bar text-4xl mb-4 text-gray-300"></i>
                                            <p>لا توجد بيانات متاحة</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Export options -->
                    <div class="dashboard-card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-6">تصدير التقارير</h3>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="exportToPDF()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                                <i class="fas fa-file-pdf mr-2"></i>
                                تصدير PDF
                            </button>
                            <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                <i class="fas fa-file-excel mr-2"></i>
                                تصدير Excel
                            </button>
                            <button onclick="printReport()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-print mr-2"></i>
                                طباعة
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="main.js"></script>
    <script>
        let monthlyChart, expenseChart;

        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            initializeCharts();
            generateReport();
            
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        });

        function loadProjects() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('reportProject');
                    data.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading projects:', error));
        }

        function initializeCharts() {
            // Monthly revenue/expense chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                    datasets: [{
                        label: 'الإيرادات',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'المصروفات',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Expense distribution chart
            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: ['رواتب', 'معدات', 'مواقع', 'تسويق', 'أخرى'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)',
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)',
                            'rgb(147, 51, 234)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function generateReport() {
            // Simulate report generation
            updateSummaryCards();
            updateCharts();
            updateProjectPerformance();
        }

        function updateSummaryCards() {
            // Simulate data
            document.getElementById('reportTotalRevenue').textContent = '0 ج.م';
            document.getElementById('reportTotalExpenses').textContent = '0 ج.م';
            document.getElementById('reportNetProfit').textContent = '0 ج.م';
            document.getElementById('reportProjectCount').textContent = '0';
        }

        function updateCharts() {
            // Update monthly chart with sample data
            monthlyChart.data.datasets[0].data = [12000, 15000, 18000, 22000, 25000, 28000];
            monthlyChart.data.datasets[1].data = [8000, 10000, 12000, 15000, 18000, 20000];
            monthlyChart.update();

            // Update expense chart with sample data
            expenseChart.data.datasets[0].data = [40, 25, 15, 10, 10];
            expenseChart.update();
        }

        function updateProjectPerformance() {
            const tbody = document.getElementById('projectPerformanceTable');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-chart-bar text-4xl mb-4 text-gray-300"></i>
                        <p>لا توجد مشاريع متاحة</p>
                    </td>
                </tr>
            `;
        }

        function exportToPDF() {
            alert('سيتم تصدير التقرير إلى PDF');
        }

        function exportToExcel() {
            alert('سيتم تصدير التقرير إلى Excel');
        }

        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
                </div>
                <div class="notifications">
                    <button class="notification-btn">🔔</button>
                    <span class="notification-count">3</span>
                </div>
                <div class="user-menu">
                    <button class="user-btn" id="user-btn">👤</button>
                    <div class="user-dropdown" id="user-dropdown">
                        <div class="user-info">
                            <span id="username-display">admin</span>
                            <small>الإدارة</small>
                        </div>
                        <hr>
                        <a href="#" onclick="logout()">تسجيل الخروج</a>
                    </div>
                </div>
            </div>
            
            <div class="nav-toggle" id="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>التقارير المالية</h1>
            <p>تقارير شاملة عن الأداء المالي للمشاريع</p>
        </div>

        <div class="content-grid">
            <!-- Report Filters -->
            <div class="card">
                <div class="card-header">
                    <h2>فلاتر التقرير</h2>
                </div>
                <div class="card-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="report-project">المشروع</label>
                            <select id="report-project">
                                <option value="">جميع المشاريع</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="report-period">الفترة الزمنية</label>
                            <select id="report-period">
                                <option value="all">جميع الفترات</option>
                                <option value="today">اليوم</option>
                                <option value="week">هذا الأسبوع</option>
                                <option value="month">هذا الشهر</option>
                                <option value="quarter">هذا الربع</option>
                                <option value="year">هذا العام</option>
                                <option value="custom">فترة مخصصة</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="custom-date-range" style="display: none;">
                            <label for="start-date">من تاريخ</label>
                            <input type="date" id="start-date">
                        </div>
                        
                        <div class="form-group" id="custom-date-range-end" style="display: none;">
                            <label for="end-date">إلى تاريخ</label>
                            <input type="date" id="end-date">
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="generateReport()">إنشاء التقرير</button>
                            <button class="btn btn-secondary" onclick="exportReport()">تصدير PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="card">
                <div class="card-header">
                    <h2>الملخص المالي</h2>
                </div>
                <div class="card-content">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">إجمالي الإيرادات</div>
                            <div class="summary-value income" id="summary-income">0 ج.م</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">إجمالي المصروفات</div>
                            <div class="summary-value expense" id="summary-expenses">0 ج.م</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">صافي الربح</div>
                            <div class="summary-value" id="summary-profit">0 ج.م</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">هامش الربح</div>
                            <div class="summary-value" id="summary-margin">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Performance -->
            <div class="card">
                <div class="card-header">
                    <h2>أداء المشاريع</h2>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>المشروع</th>
                                    <th>الميزانية المخططة</th>
                                    <th>المبلغ المصروف</th>
                                    <th>المتبقي</th>
                                    <th>نسبة الإنجاز</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="projects-performance">
                                <!-- Project performance data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expense Breakdown -->
            <div class="card">
                <div class="card-header">
                    <h2>تفصيل المصروفات</h2>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="expense-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monthly Trends -->
            <div class="card">
                <div class="card-header">
                    <h2>الاتجاهات الشهرية</h2>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="trends-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Expenses -->
            <div class="card">
                <div class="card-header">
                    <h2>أكبر المصروفات</h2>
                </div>
                <div class="card-content">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>الوصف</th>
                                    <th>المشروع</th>
                                    <th>الفئة</th>
                                    <th>المبلغ</th>
                                    <th>التاريخ</th>
                                </tr>
                            </thead>
                            <tbody id="top-expenses">
                                <!-- Top expenses will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="main.js"></script>
    <script>
        let projects = [];
        let transactions = [];
        let reportData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadProjects();
            loadTransactions();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('report-period').addEventListener('change', function() {
                const customDateRange = document.getElementById('custom-date-range');
                const customDateRangeEnd = document.getElementById('custom-date-range-end');
                
                if (this.value === 'custom') {
                    customDateRange.style.display = 'block';
                    customDateRangeEnd.style.display = 'block';
                } else {
                    customDateRange.style.display = 'none';
                    customDateRangeEnd.style.display = 'none';
                }
            });
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                if (response.ok) {
                    projects = await response.json();
                    updateProjectSelect();
                }
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions');
                if (response.ok) {
                    transactions = await response.json();
                } else {
                    transactions = [];
                }
                generateReport();
            } catch (error) {
                console.error('Error loading transactions:', error);
                transactions = [];
                generateReport();
            }
        }

        function updateProjectSelect() {
            const select = document.getElementById('report-project');
            
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
        }

        function generateReport() {
            const projectId = document.getElementById('report-project').value;
            const period = document.getElementById('report-period').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            // Filter data based on selections
            let filteredTransactions = [...transactions];
            let filteredProjects = [...projects];

            // Filter by project
            if (projectId) {
                filteredTransactions = filteredTransactions.filter(t => t.project_id == projectId);
                filteredProjects = filteredProjects.filter(p => p.id == projectId);
            }

            // Filter by date period
            filteredTransactions = filterByPeriod(filteredTransactions, period, startDate, endDate);

            // Generate report data
            reportData = {
                transactions: filteredTransactions,
                projects: filteredProjects,
                period: period,
                startDate: startDate,
                endDate: endDate
            };

            updateFinancialSummary();
            updateProjectPerformance();
            updateTopExpenses();
            // Note: Chart functionality would require a charting library like Chart.js
        }

        function filterByPeriod(transactions, period, startDate, endDate) {
            const now = new Date();
            let filterStartDate, filterEndDate;

            switch (period) {
                case 'today':
                    filterStartDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filterEndDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    filterStartDate = weekStart;
                    filterEndDate = new Date(weekStart);
                    filterEndDate.setDate(weekStart.getDate() + 7);
                    break;
                case 'month':
                    filterStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    filterEndDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    filterStartDate = new Date(now.getFullYear(), quarter * 3, 1);
                    filterEndDate = new Date(now.getFullYear(), (quarter + 1) * 3, 1);
                    break;
                case 'year':
                    filterStartDate = new Date(now.getFullYear(), 0, 1);
                    filterEndDate = new Date(now.getFullYear() + 1, 0, 1);
                    break;
                case 'custom':
                    if (startDate && endDate) {
                        filterStartDate = new Date(startDate);
                        filterEndDate = new Date(endDate);
                        filterEndDate.setDate(filterEndDate.getDate() + 1);
                    } else {
                        return transactions;
                    }
                    break;
                default:
                    return transactions;
            }

            return transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= filterStartDate && transactionDate < filterEndDate;
            });
        }

        function updateFinancialSummary() {
            const income = reportData.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const expenses = reportData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const profit = income - expenses;
            const margin = income > 0 ? ((profit / income) * 100).toFixed(1) : 0;

            document.getElementById('summary-income').textContent = formatCurrency(income);
            document.getElementById('summary-expenses').textContent = formatCurrency(expenses);
            document.getElementById('summary-profit').textContent = formatCurrency(profit);
            document.getElementById('summary-profit').className = `summary-value ${profit >= 0 ? 'income' : 'expense'}`;
            document.getElementById('summary-margin').textContent = `${margin}%`;
        }

        function updateProjectPerformance() {
            const tbody = document.getElementById('projects-performance');
            tbody.innerHTML = '';

            if (reportData.projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد مشاريع</td></tr>';
                return;
            }

            reportData.projects.forEach(project => {
                const projectExpenses = reportData.transactions
                    .filter(t => t.project_id == project.id && t.type === 'expense')
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                const remaining = project.total_budget - projectExpenses;
                const progress = project.total_budget > 0 ? ((projectExpenses / project.total_budget) * 100).toFixed(1) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${project.name}</td>
                    <td>${formatCurrency(project.total_budget)}</td>
                    <td>${formatCurrency(projectExpenses)}</td>
                    <td class="${remaining >= 0 ? 'income' : 'expense'}">${formatCurrency(remaining)}</td>
                    <td>${progress}%</td>
                    <td><span class="status ${project.status}">${getStatusText(project.status)}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateTopExpenses() {
            const tbody = document.getElementById('top-expenses');
            tbody.innerHTML = '';

            const expenses = reportData.transactions
                .filter(t => t.type === 'expense')
                .sort((a, b) => parseFloat(b.amount) - parseFloat(a.amount))
                .slice(0, 10);

            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد مصروفات</td></tr>';
                return;
            }

            expenses.forEach(expense => {
                const project = projects.find(p => p.id == expense.project_id);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${expense.description}</td>
                    <td>${project ? project.name : 'غير محدد'}</td>
                    <td>${expense.category}</td>
                    <td class="expense">${formatCurrency(expense.amount)}</td>
                    <td>${formatDate(expense.date)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportReport() {
            // This would typically generate a PDF report
            // For now, we'll show a notification
            showNotification('سيتم إضافة ميزة تصدير PDF قريباً', 'info');
        }

        function getStatusText(status) {
            const statusMap = {
                'planning': 'تخطيط',
                'in-progress': 'قيد التنفيذ',
                'completed': 'مكتمل',
                'on-hold': 'متوقف'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG', {
                style: 'currency',
                currency: 'EGP',
                minimumFractionDigits: 0
            }).format(amount);
        }
    </script>
</body>
</html>

